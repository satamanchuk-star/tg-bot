# AlexBot

Telegram-бот для управления форумом жилого комплекса. Построен на Python 3.12 и aiogram 3.4.1.

## Возможности

- **Модерация**: страйки, мут, бан пользователей
- **Игры**: блэкджек с внутриигровой валютой (монеты)
- **Статистика**: отслеживание активности по топикам форума
- **Фильтрация**: автоматическая проверка на мат и флуд

## Архитектура

```
app/
├── main.py              # Точка входа, настройка бота и планировщика
├── config.py            # Конфигурация через переменные окружения
├── db.py                # Async SQLAlchemy + SQLite
├── models.py            # ORM-модели
├── handlers/            # Роутеры aiogram
│   ├── admin.py         # /mute, /ban, /strike, /addcoins
│   ├── games.py         # /21 — блэкджек
│   ├── moderation.py    # Фильтрация контента
│   └── ...
├── services/            # Бизнес-логика
│   ├── games.py         # Логика блэкджека, лидерборд
│   ├── strikes.py       # Управление страйками
│   └── ...
└── utils/               # Вспомогательные функции
```

**Ключевые принципы:**
- Полностью асинхронный код (async/await)
- Разделение на handlers (обработка команд) и services (бизнес-логика)
- Планировщик APScheduler для периодических задач (лидерборд, heartbeat)

## Конфигурация

Переменные окружения в `.env` (см. `.env.example`):

| Переменная | Описание |
|------------|----------|
| `BOT_TOKEN` | Токен бота от BotFather |
| `FORUM_CHAT_ID` | ID форума (supergroup) |
| `ADMIN_LOG_CHAT_ID` | Куда слать логи админу |
| `DATABASE_URL` | Строка подключения к БД (по умолчанию SQLite) |
| `TIMEZONE` | Часовой пояс (по умолчанию Europe/Moscow) |
| `BUILD_VERSION` | Версия сборки для логов (по умолчанию dev) |
| `AI_*` | Настройки AI endpoint, таймаутов, ретраев и лимитов |
| `AI_FEATURE_*` | Точечное отключение AI-функций (модерация/ассистент/викторина/сводка) |
| `TOPIC_*` | ID топиков форума (см. `.env.example`) |

## AI: включение и диагностика

1. Заполните `AI_API_URL` и `AI_KEY`.
2. При необходимости выставьте лимиты: `AI_DAILY_REQUEST_LIMIT`, `AI_DAILY_TOKEN_LIMIT`.
3. Включите/выключите фичи через `AI_FEATURE_*`.
4. Проверьте доступность командой `/ai_ping` (покажет `OK/FAIL` и latency).
5. Проверьте состояние `/ai_status` (лимиты, расход, остаток, время до сброса, последняя ошибка).
6. При проблемах можно сбросить счётчики командой `/ai_reset`.

### Ежедневная AI-сводка

- Время отправки: `AI_SUMMARY_HOUR` + `AI_SUMMARY_MINUTE` (в `TIMEZONE`).
- Если задан `AI_SUMMARY_TOPIC_ID`, сводка уйдет в этот топик `FORUM_CHAT_ID`.
- Если `AI_SUMMARY_TOPIC_ID` пуст, сводка уйдет в `ADMIN_LOG_CHAT_ID`.
- Формат: сначала AI-резюме, затем сырая статистика.
- Если AI недоступен/отключен/уперся в лимит, статистика всё равно придет с пометкой о деградации.

### Фолбэки

- При timeout/сетевых/5xx ошибках — ретраи (`AI_RETRIES`), затем локальный fallback.
- При 401/403 — без ретраев, сразу fallback.
- При превышении лимита AI-вызов не выполняется, используется fallback.
- Техническая причина сохраняется и видна в `/ai_status`.

## CI/CD

При пуше в `main` автоматически собирается и пушится Docker-образ (GitHub Actions).

Секреты в репозитории (Settings → Secrets → Actions):
- `DOCKERHUB_USERNAME` — логин Docker Hub
- `DOCKERHUB_TOKEN` — Access Token

## Деплой

Собрать образ локально (или дождаться CI):
```bash
# Linux/macOS
sh build.sh

# Windows
build.bat
```

На сервере:
```bash
cd /opt/alexbot

# Обновить приложение
sh reload.sh

# Посмотреть логи
docker compose logs
```

## Локальный запуск

```bash
# Установить зависимости
pip install -r requirements.txt

# Запустить бота
python -m app.main
```

## Как проверить на стенде (быстрый сценарий)

1. `cp .env.example .env` и заполнить обязательные переменные.
2. Запустить: `python -m app.main`.
3. В Telegram выполнить `/ai_ping`.
4. Выполнить `/ai_status` и проверить лимиты/остаток.
5. Отправить `/ai как решить вопрос со шлагбаумом`.
6. Временно поставить `AI_DAILY_REQUEST_LIMIT=1`, перезапустить и сделать 2 AI-запроса.
7. Убедиться, что второй запрос ушел в fallback без падения бота.
8. Выполнить `/ai_reset` и проверить `/ai_status`.
9. Дождаться времени сводки или временно вызвать job в отладке.
10. Проверить, что приходят AI-резюме + статистика (или fallback + статистика).

## Почему бот может не запускаться

1. Не заполнен `.env` (минимум `BOT_TOKEN`, `FORUM_CHAT_ID`, `ADMIN_LOG_CHAT_ID`).
2. Бот был остановлен командой `/shutdown_bot` и остался файл-флаг `.stopped` в каталоге данных (`/app/data` или рядом с SQLite-файлом из `DATABASE_URL`).
3. Неверный `BOT_TOKEN` или нет доступа к Telegram API (на старте есть 3 попытки `get_me`).

Быстрая самопроверка:

```bash
cp .env.example .env
# заполните обязательные поля и перезапустите
python -m app.main
```


## Викторина: загрузка вопросов

Команда `/load_quiz` загружает вопросы из файла `viktorinavopros_QA.xlsx` в корне проекта.

Требования к таблице:
- Лист `sheet1`.
- Колонка A — вопрос.
- Колонка B — ответ.
