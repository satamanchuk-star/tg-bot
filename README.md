# AlexBot

Telegram-бот для управления форумом жилого комплекса. Построен на Python 3.12 и aiogram 3.4.1.

## Возможности

- **Модерация**: страйки, мут, бан пользователей
- **Игры**: блэкджек с внутриигровой валютой (монеты)
- **Статистика**: отслеживание активности по топикам форума
- **Фильтрация**: автоматическая проверка на мат и флуд

## Архитектура

```
app/
├── main.py              # Точка входа, настройка бота и планировщика
├── config.py            # Конфигурация через переменные окружения
├── db.py                # Async SQLAlchemy + SQLite
├── models.py            # ORM-модели
├── handlers/            # Роутеры aiogram
│   ├── admin.py         # /mute, /ban, /strike, /addcoins
│   ├── games.py         # /21 — блэкджек
│   ├── moderation.py    # Фильтрация контента
│   └── ...
├── services/            # Бизнес-логика
│   ├── games.py         # Логика блэкджека, лидерборд
│   ├── strikes.py       # Управление страйками
│   └── ...
└── utils/               # Вспомогательные функции
```

**Ключевые принципы:**
- Полностью асинхронный код (async/await)
- Разделение на handlers (обработка команд) и services (бизнес-логика)
- Планировщик APScheduler для периодических задач (лидерборд, heartbeat)

## Конфигурация

Переменные окружения в `.env` (см. `.env.example`):

| Переменная | Описание |
|------------|----------|
| `BOT_TOKEN` | Токен бота от BotFather |
| `FORUM_CHAT_ID` | ID форума (supergroup) |
| `ADMIN_LOG_CHAT_ID` | Куда слать логи админу |
| `DATABASE_URL` | Строка подключения к БД (по умолчанию SQLite) |
| `TIMEZONE` | Часовой пояс (по умолчанию Europe/Moscow) |
| `BUILD_VERSION` | Версия сборки для логов (по умолчанию dev) |
| `AI_*` | Настройки AI endpoint, таймаутов, ретраев и лимитов |
| `AI_FEATURE_*` | Точечное отключение AI-функций (модерация/ассистент/викторина/сводка) |
| `TOPIC_*` | ID топиков форума (см. `.env.example`) |

## AI: текущий статус

Бот поддерживает два режима AI:
- **Remote AI**: если заданы `AI_KEY` (и опционально `AI_API_URL`, `AI_MODEL`), используется внешний провайдер через Chat Completions API.
- **Stub fallback**: если ключ не задан или API недоступен, бот автоматически работает в локальном режиме без падений.

В remote-режиме включены:
- модерация (структурированное решение: тип/severity/action);
- ассистент (`/ai`, упоминания, reply) с ограничением ответа до 800 символов;
- AI-оценка ответа викторины;
- AI-резюме в ежедневной сводке.

Дополнительно учитываются суточные лимиты запросов/токенов (`AI_DAILY_REQUEST_LIMIT`, `AI_DAILY_TOKEN_LIMIT`).

## CI/CD

При пуше в `main` автоматически собирается и пушится Docker-образ (GitHub Actions).

Секреты в репозитории (Settings → Secrets → Actions):
- `DOCKERHUB_USERNAME` — логин Docker Hub
- `DOCKERHUB_TOKEN` — Access Token
- `SSH_HOST` — адрес сервера для деплоя
- `SSH_USER` — пользователь на сервере
- `SSH_PRIVATE_KEY` — приватный SSH-ключ
- `AI_KEY` — ключ OpenRouter; при деплое автоматически записывается в `/opt/alexbot/.env`

## Деплой

Собрать образ локально (или дождаться CI):
```bash
# Linux/macOS
sh build.sh

# Windows
build.bat
```

На сервере:
```bash
cd /opt/alexbot

# Обновить приложение
sh reload.sh

# Посмотреть логи
docker compose logs
```

## Локальный запуск

```bash
# Установить зависимости
pip install -r requirements.txt

# Запустить бота
python -m app.main
```

## Как проверить на стенде (быстрый сценарий)

1. `cp .env.example .env` и заполнить обязательные переменные.
2. Запустить: `python -m app.main`.
3. В Telegram выполнить `/help` и проверить меню.
4. Выполнить `/ai` и убедиться, что приходит сообщение о заглушке.
5. Упомянуть бота в сообщении и проверить локальный ответ.
6. Запустить/дождаться ежедневной сводки и убедиться, что приходит только статистика.


## Проверка OpenRouter API

Быстрый health-check без запуска бота:

```bash
python scripts/check_openrouter.py --api-key sk-or-...
```

Если аргументы не переданы, скрипт берёт `AI_KEY` (или `OPENROUTER_API_KEY`), `AI_MODEL`, `AI_API_URL`
сначала из переменных окружения процесса, затем из локального файла `.env`.

Или через переменные окружения:

```bash
AI_KEY=sk-or-... AI_MODEL=qwen/qwen3-14b python scripts/check_openrouter.py
# или
OPENROUTER_API_KEY=sk-or-... AI_MODEL=qwen/qwen3-14b python scripts/check_openrouter.py
```

Скрипт вернет `ok/status_code/latency_ms/details` и завершится кодом:
- `0` — API доступен и вернул `choices`;
- `1` — API ответил ошибкой или сеть недоступна;
- `2` — не передан API-ключ.

## Почему бот может не запускаться

1. Не заполнен `.env` (минимум `BOT_TOKEN`, `FORUM_CHAT_ID`, `ADMIN_LOG_CHAT_ID`).
2. Бот был остановлен командой `/shutdown_bot` и остался файл-флаг `.stopped` в каталоге данных (`/app/data` или рядом с SQLite-файлом из `DATABASE_URL`).
3. Неверный `BOT_TOKEN` или нет доступа к Telegram API (на старте есть 3 попытки `get_me`).

Быстрая самопроверка:

```bash
cp .env.example .env
# заполните обязательные поля и перезапустите
python -m app.main
```


## Викторина: загрузка вопросов

Команда `/load_quiz` загружает вопросы из файла `viktorinavopros_QA.xlsx` в корне проекта.

Требования к таблице:
- Лист `sheet1`.
- Колонка A — вопрос.
- Колонка B — ответ.
